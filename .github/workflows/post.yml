name: post

on:
  schedule:
    - cron: "0 */8 * * *"   # every 8 hours
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: Run actions/checkout@v4
        uses: actions/checkout@v4

      - name: Run actions/setup-node@v4
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Verify repo contents
        run: |
          echo "PWD=$(pwd)"
          echo "TREE:"
          find . -maxdepth 3 -type f -print | sort
          echo
          if [ -f post-metrics.js ]; then
            echo "SHA256 post-metrics.js:"
            sha256sum post-metrics.js
            echo
            echo "HEAD post-metrics.js:"
            sed -n '1,60p' post-metrics.js
            echo
          else
            echo "post-metrics.js NOT FOUND at repo root"; exit 1
          fi

      - name: Install deps
        run: npm ci

      - name: Node env info
        run: |
          node -v
          npm -v

      - name: Post metrics (dry-run unless explicitly disabled)
        env:
          X_APP_KEY:        ${{ secrets.X_APP_KEY }}
          X_APP_SECRET:     ${{ secrets.X_APP_SECRET }}
          X_ACCESS_TOKEN:   ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET:  ${{ secrets.X_ACCESS_SECRET }}
          EXPLAINER_URL:    ${{ vars.EXPLAINER_URL }}
          BTC_TIER:         ${{ vars.BTC_TIER }}
          # default to DRY_RUN=1 unless you set a repo variable DRY_RUN=0
          DRY_RUN:          ${{ vars.DRY_RUN || '1' }}
        run: |
          set -euo pipefail
          node post-metrics.js
