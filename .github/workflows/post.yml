name: Post metrics

on:
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: "Set to 1 to run without tweeting"
        required: false
        default: "1"
  schedule:
    - cron: "0 */8 * * *"  # every 8 hours UTC

env:
  # Defaults (can be overridden with Repository Variables)
  BTC_TIER: hourFee
  EXPLAINER_URL: ""

jobs:
  post:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      statuses: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install
        run: npm ci --omit=dev

      - name: Post metrics
        env:
          X_APP_KEY: ${{ secrets.X_APP_KEY }}
          X_APP_SECRET: ${{ secrets.X_APP_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          # Prefer manual input; fall back to repo vars; then to defaults in env above
          DRY_RUN: ${{ github.event.inputs.DRY_RUN || '' }}
          BTC_TIER: ${{ vars.BTC_TIER || env.BTC_TIER }}
          EXPLAINER_URL: ${{ vars.EXPLAINER_URL || env.EXPLAINER_URL }}
        run: node post-metrics.js
